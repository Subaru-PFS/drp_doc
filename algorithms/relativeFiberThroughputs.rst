Relative Fiber Throughputs
==========================

The science mission of PFS demands accurate sky subtraction
in order to detect faint galaxy emission lines near bright sky lines,
which requires accurate and precise relative fiber throughputs.

Because the blank sky is observed by a separate set of fibers
from those recording the science targets,
we need to able to relate the relative signals of fibers across the instrument
and as a function of wavelength:
we need to be able to connect the fluxes measured
in fiber :math:`i` with the fluxes measured in fiber :math:`j`,
despite the fact that the photons come from different parts of the sky,
pass through different fibers,
different spectrographs
and are measured by different detectors.
We also need to be able to connect the fluxes measured for fiber :math:`k`
in the blue, red and NIR arms.

Unfortunately, it has become clear that the relative fiber throughputs vary with time,
with large changes occurring between observing runs
as the fiber connectors are unplugged and re-plugged,
and smaller (but still significant) changes occurring within a run
and even within a night as forces act on the fiber connectors.


General strategy
----------------

We would strongly prefer to be able to predict the relative fiber throughputs
on the basis of calibration observations taken with high signal-to-noise
at the beginning and end of the night,
and the following strategy reflects this desire.
It may be that reaching our science goals requires adding a more sophisticated approach
(e.g., using the sky lines themselves to monitor the relative fiber throughputs),
but that will require additional research and development.

We use quartz exposures as a reference to connect measured signals
in different fibers, spectrographs and wavelengths.
The quartz provides a single bright light source observed simultaneously
by all fibers and spectrograph cameras.

The measured quartz spectra
(with some corrections applied; see below)
are recorded in the ``fiberNorms_calib``.
These normalisation spectra are then propagated to the ``pfsArm.norm`` spectra
when the spectra are extracted,
and these are the basis for the relative fiber throughputs measured in the ``fiberNorms``.


Corrections
-----------

The ``pfsArm`` normalisations have two corrections applied to them.

The first attempts to account for the shadow of the black spots on the fibers.
This correction is simplistic and inaccurate,
and we therefore strive to keep fibers out of the shadow of the black spots
in order to avoid adding systematic errors.
The correction is a linear function of the distance of the fiber from the black spot
(which is known to be a poor approximation of the more complicated geometry of the shadows):

.. math::

    c_{\rm bs} & = \textrm{max}(1 - m(r - d), 0) & {\rm if}\ d < r

    c_{\rm bs} & = 1 & {\rm if}\ d \geq\ r

where :math:`m = 1.108` is the slope of the correction (in mm\ :sup:`-1`),
:math:`r = 1.232` is the radius of the black spot shadow (in mm),
and :math:`d` is the distance of the fiber from the center of the black spot (in mm).

The second correction is the screen illumination correction,
which is only applied to exposures that have active lamps
(i.e., not sky exposures),
with the intent of correcting the quartz spectra to look like they come from the sky.
The correction is:

.. math::

    c_{\rm scr} = a x' y' + b x' + c y' + 1

where :math:`a \sim\ -1.6 \times\ 10^{-7}`,
:math:`b \sim\ -8.0 \times\ 10^{-5}`
and :math:`c \sim\ -1.1 \times 10^{-4}`
are the coefficients;
:math:`x'` and :math:`y'` is the position on the focal plane (in mm)
after correcting for the instrument rotator angle.

.. math::

    x' & = x \cos\theta - y \sin\theta \\
    y' & = x \sin\theta + y \cos\theta

where :math:`x` and :math:`y` are the positions on the focal plane (in mm) from the ``pfsConfig``,
and :math:`\theta` is the instrument rotator angle
(from the ``INSROT`` header keyword).

The ``pfsArm.norm`` spectra are therefore:

.. math::

    \tt{pfsArm.norm} = \tt{fiberNorms} \times c_{\rm bs} \times c_{\rm scr}

Note that the corrections are applied to the ``pfsArm.norm`` rather than ``pfsArm.flux``,
because we want ``pfsArm.flux`` to be identical to the spectra extracted from the image.
The goal is that the ``pfsArm.flux/pfsArm.norm`` values will be
corrected for relative throughput differences.


fiberNorms for calibration
--------------------------

The ``fiberNorms_calib`` are generated by combining multiple [#]_ ``pfsArm`` spectra of quartzes,
with corrections for the above effects.
This provides a high-quality quartz spectrum for use in calibration of science exposures.

.. [#] Usually consecutive exposures, with the quartz lamp stable.


fiberNorms residuals
--------------------

The ``fiberNorms`` product is the ratio of the flux of a new quartz
(corrected for the above effects)
to the quartz spectrum recorded in the ``fiberNorms_calib``.
It can be thought of as the residuals:
the value should be constant for all wavelengths and fibers if the fiber throughput is stable.

Note that the values of the ``fiberNorms`` depend on
the choice of ``fiberProfiles`` used in the spectral extraction.
In order to protect the user against using ``fiberNorms_calib``
that are not appropriate for a given ``pfsArm``,
we record a hash of the ``fiberProfiles`` used for the extractions,
and check that the hashes are consistent.


Measurement
~~~~~~~~~~~

The ``fiberNorms`` are measured from the ``pfsArm`` spectra of quartz exposures:

.. math::

    \tt{fiberNorms} = \tt{pfsArm.flux} / \tt{pfsArm.norm}

Because ``pfsArm.flux`` is the flux of the new quartz,
and ``pfsArm.norm`` contains the flux of the original reference quartz
(from the ``fiberNorms_calib``; modulo the above corrections),
the ``fiberNorms`` are the ratio of the flux of the new quartz to the flux of the original reference quartz:

.. math::

    N_{\rm new} & \equiv F_{\rm new} \\
                & = f_{\rm new} / n_{\rm new} \\
                & = f_{\rm new} / ( F_{\rm ref} \, c_{\rm bs,new} \, c_{\rm scr,new}) \\
                & = f_{\rm new} \, c_{\rm bs,ref} \, c_{\rm scr,ref} / ( f_{\rm ref} \, c_{\rm bs,new} \, c_{\rm scr,new}) \\
                & = \frac{f_{\rm new}}{f_{\rm ref}} \times \left( \frac{c_{\rm bs,new} \, c_{\rm scr,new}}{c_{\rm bs,ref} \, c_{\rm scr,ref}} \right)^{-1}

where :math:`N` is the ``fiberNorms``,
:math:`F_{\rm new}` is the normalized flux of the new quartz,
:math:`f_{\rm new}` is the extracted flux of the new quartz,
:math:`n_{\rm new}` is the normalization values of the new quartz,
:math:`c_{\rm bs,new}` is the black spot correction for the new quartz,
:math:`c_{\rm scr,new}` is the screen illumination correction for the new quartz,
and the ``ref`` subscript refers similarly to the reference quartz.

Even if there are no changes to the system throughput,
the ``fiberNorms`` values will deviate from a mean value of unity
if the brightness of the quartz lamp changes
or if the exposure time is different.
This feature may be useful for monitoring the stability of the system,
but if it is considered annoying we may remove (and record) the median value to simplify the analysis.


Naming
~~~~~~

Under the former Gen2 middleware system:

- The quartz normalization spectra that are now called ``fiberNorms_calib``
  were stored in the ``fiberProfiles``.
- The ``fiberNorms`` were an additional calibration product,
  with the same kind of "residual" meaning as they have now,
  except that they were optionally generated from multiple exposures.
  The quartz normalization spectra corrected by the ``fiberNorms``
  were our best guess model for the relative fiber throughputs.
- The ``fiberNorms_meas`` were what we now call ``fiberNorms``.
  They were our best estimate of the actual relative fiber throughputs.

Under the new (since October 2024) Gen3 middleware system,
this naming scheme has changed to what is described above:

- ``fiberNorms_calib``: the certified calib,
  contains the quartz normalization spectra (i.e., not the residuals).
  Dividing these by the mean quartz spectrum would give
  our best guess model for the relative fiber throughputs.
- ``fiberNorms``: the measured relative fiber throughputs,
  which is our best estimate of the actual relative fiber throughputs.

There are three important differences to note between these two systems:

- The ``fiberNorms_calib`` in the Gen3 system contains quartz spectra, not ratios.
- The ``fiberNorms`` in the Gen3 system are
  the measured relative fiber throughputs for a particular exposure;
  while in the Gen2 system they were part of the model.
- The ``fiberNorms_meas`` in the Gen2 system are now called ``fiberNorms`` in the Gen3 system.
