###########
2D DRP Plan
###########

Doc Code: PFS-DRP-PRU030002-01

Introduction
============

Aim
---

This document describes the current working plan for DRP development, 
covering the period from October 2018 until the end of operations.


Data flow
---------

.. figure:: DRP-flow.png
  :width: 80%

The data flow for 2D DRP processing is depicted in the figure above. Blue boxes indicate main processing units, and white boxes key input data types.
The instrument and its corresponding simulator are shown in central green boxes. The outputs of the simulator and instrument are in general the same (as expected if the simulator simulates the instrument correctly), with the exception that the instrument will provide bias, darks and flats that can be later used by the simulator.


Notes
-----

* Each 2D-DRP release is named according to an incremental version number of the form ``<major>.<minor>`` . For historical reasons, the initial version described in this plan is 4.0 .

Comments and Open Points
------------------------
* Most of work described here will be done by developers at Princeton University. The 1D sky subtraction is expected to be done through two independent methods provided by NAOJ (Sogo Mineo) and IPMU (Naoki Yasuda)
* Sky subtraction: target metric is mentioned in Tamura et al (2016) as '0.5% of the faint sky continuum between the lines'. This needs to be defined even more precisely so that sky subtraction solution can be developed and tested adequately.


2DDRP-4.0 (Sep 2018)
====================

This is the initial release of the pipeline. Used for SM1 r-channel testing at LAM.

- Basic functionality (detectorMap, flat-fielding, fiber-fiber flux calibration)
- Low-level test harness

2DDRP-5.0 (Jan 2019)
====================

This is an intermediate release for K Yabe for 1D sky subtraction study, survey simulation etc. Initial end-to-end demonstration of pipeline. Integration test incorporates the 2D simulator,
that provides test quartz, arcs and science data. The SIM2D/2D DRP output will be checked against the ETC output prior to release (`SIM2D-88 <https://pfspipe.ipmu.jp/jira/browse/SIM2D-88>`_). For SIM2D and 2D DRP, all outputs will be defined in data model, and generated by these systems. If necessary, mock outputs are generated where no meaningful data can be produced.

- Packaged SIM2D (with all outputs defined in data model and generated)
- Packaged 2D DRP (with all outputs defined in data model and generated)
- SIM2D/2D DRP output checked against ETC.
- Example LSF for 1-D sky subtraction analysis
- all 3 arms (R, B, N) processed (and possibly M). 
- 3 arms merged
- Design Document (providing key components and a description for each)
- Initial Software User's Manual (providing installation instructions, command-line usage, output files and formats etc).

2DDRP-6.0 (Sep 2019)
====================

Quick processing of exposures within 15 minutes is required (J Gunn priv comm 2018). If this is not possible using the full DRP pipeline, a special mode of the pipeline that makes use of more approximate models (eg utilising a more approximate PSF model) will be introduced to achieve this goal. 2D Simulator delivered with initial 2D PSF model and initial modelling of NIR data.

- re-implemented flat-fielding in accordance to new framework
- Initial absolute flux calibration
- Provisional H4RG processing.
- Initial 2D PSF model 
- Initial 1D and 2D sky subtraction
- Initial telluric absorption
- Co-adding of exposures
- Initial 'Quick' DRP mode available and demonstratable
- 2D Simulator delivery with initial 2D PSF model
- Advanced Software User's Manual

2DDRP-7.0 (Apr 2020)
====================

Version for early PSF commissioning. Data taken following PFI installation will be used for calibration and 2D PSF modelling improvements. 'Quick' DRP as well as the 'full' DRP should be available. Quick DRP should function at LAM as well as at the summit, in coordination with the ICS. 2D sky subtraction using arcs (TBC). Robust and simple 1D sky subtraction. 2D simulator NIR modelling advanced.

- Improved H4RG data processing
- Updated 2D PSF model based on real data from instrument
- 2D sky subtraction per arm (to 2% [TBC] of the faint sky continuum between the lines)
- 1D sky subtraction (to 2% [TBC])
- Updated quick DRP available 

2DDRP-8.0 (Sep 2020)
====================

Updated version for commissioning. Raster scan observations will take place at this time to refine the accuracy of fiber positioning. For this, quick DRP will output numeric data of wavelength-calibrated, flux-calibrated one-dimensionalized spectra. with improvements based on acquired data during the early commissioning phase. Updates to the pipeline will be made based on acquired data (particularly 3-4 hours of dark time, ~2 hrs of which are contiguous), from SM1 and SM2 modules initially.

- Further improvements to 2D PSF model
- Improved telluric absorption
- Updated 2D sky subtraction (to 1% of the faint sky continuum between the lines [TBC])
- Updated Quick DRP for wavelength-calibrated spectra

2DDRP-9.0 (Apr 2021)
====================

Intermediate release with functional updates. Pipeline incorporates acquired data from all 4 SM modules.

- Sky subtraction to 0.5% of the faint sky continuum between the lines
- Performance (speed) improved 

2DDRP-10.0 (Jan 2021)
====================

Further improvements. 
- Bug fixes
- Missing functions
- Refactoring
- Performance (speed) improvements





